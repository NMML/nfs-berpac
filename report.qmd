---
title: "Northern Fur Seal Movement, Dive Behavior, and Oceanography in the Bering Sea and Pacific Ocean"
format: html
---

```{r}
#| include: false
library(tidyverse)
library(wcUtils)
library(sf)
library(trip)
library(crawl)
library(crawlUtils)
library(googlesheets4)
library(rdeck)

deploy_tbl <- read_sheet(
  "1geSmkVzPK_nOkR-bdO5WpM0qHo8Xsw0poYWOz-k2trk"
) %>% 
  select(2,5,10) %>% 
  janitor::clean_names() %>% 
  rename(deployid = deploy_id) %>% 
  mutate(deploy_date_time_gmt = lubridate::force_tz(deploy_date_time_gmt,"UTC"))

r_files <- fs::dir_ls(here::here('R'), glob = "*.R")
map(r_files, source)
```

```{r}
#| include: false
data_list <- get_wc_data()
```


## Updated Map of Movements

```{r}
#| echo: false
#| message: false
#| warning: false
locs <- sf::st_as_sf(data_list$locs,
                     coords = c("longitude","latitude"),
                     crs = 4326) %>% 
  left_join(deploy_tbl) %>% 
  dplyr::filter(date_time > deploy_date_time_gmt) %>% 
  dplyr::rename(datetime=date_time)

locs <- locs %>%
  group_by(deployid) %>%
  arrange(datetime, error_radius) %>%
    mutate(
      rank = 1L,
      rank = case_when(duplicated(datetime, fromLast = FALSE) ~
                         lag(rank) + 1L, TRUE ~ rank)) %>%
    dplyr::filter(rank == 1) %>% 
  filter_tracks() %>% 
  sf::st_transform(32606) %>% 
  cu_add_argos_cols()

locs_fit <- locs %>% 
  group_by(deployid) %>% 
  group_map(~cu_crw_argos(.x), .keep = TRUE) %>% 
  purrr::flatten()

predict_pts <- locs_fit %>% 
  cu_crw_predict(predTime="1 hour", as_sf=FALSE)

deploy_ids <- predict_pts %>% map("deployid") %>% map_chr(head,1L)

predict_pts_sf <- predict_pts %>%  
  map(crw_as_sf,locType = "p", ftype = "POINT") %>%
  bind_rows() %>% 
  left_join(deploy_tbl)

predict_lines_sf <- predict_pts %>% 
  map(crw_as_sf,locType = "p", ftype = "LINESTRING") %>%
  set_names(deploy_ids) %>% 
  bind_rows(.id="deployid") %>% 
  select(-id) %>% 
  left_join(deploy_tbl)

initial_bounds <- sf::st_buffer(st_bbox(predict_lines_sf) %>% 
                                  st_as_sfc(),100000) %>% 
  sf::st_transform(4326)
                                  

lines_smi <- filter(predict_lines_sf, deployment_location == "San Miguel Island, CA") %>% 
  sf::st_transform(4326)
lines_stp <- filter(predict_lines_sf, deployment_location == "St. Paul Island, AK") %>% 
  sf::st_transform(4326)

locs_smi <- filter(predict_pts_sf, deployment_location == "San Miguel Island, CA") %>% 
  sf::st_transform(4326) %>% tail(1L)
locs_stp <- filter(predict_pts_sf, deployment_location == "St. Paul Island, AK") %>% 
  sf::st_transform(4326) %>% tail(1L)

full_map <- rdeck(map_style = "mapbox://styles/jmlondon/cl9kktfl2000v16pooqw5p2wz",
                initial_bounds = initial_bounds,
                controller = TRUE) %>%
  add_path_layer(data = lines_smi,
                    name = "San Miguel",
                    opacity = 0.8,
                    get_color = scale_color_category(
                      col = deployid,
                      palette = scales::brewer_pal("seq","Oranges"),
                      ),
                    wrap_longitude = TRUE,
                    position_format = "XY",
                    width_min_pixels = 1.5,
                    get_path = geometry) %>%
  add_path_layer(data = lines_stp,
                    name = "St. Paul",
                    opacity = 0.8,
                    get_color = scale_color_category(
                      col = deployid,
                      palette = scales::brewer_pal("seq","Greens"),
                      ),
                    wrap_longitude = TRUE,
                    position_format = "XY",
                    width_min_pixels = 1.5,
                    get_path = geometry) %>% 
  add_scatterplot_layer(data = locs_smi,
                    name = "San Miguel",
                    opacity = 1,
                    get_fill_color = scale_color_category(
                      col = deployid,
                      palette = scales::brewer_pal("seq","Oranges"),
                      ),
                    wrap_longitude = TRUE,
                    position_format = "XY",
                    radius_min_pixels = 4,
                    get_position = geometry) %>%
  add_scatterplot_layer(data = locs_stp,
                    name = "St. Paul",
                    opacity = 1,
                    get_fill_color = scale_color_category(
                      col = deployid,
                      palette = scales::brewer_pal("seq","Greens"),
                      ),
                    wrap_longitude = TRUE,
                    position_format = "XY",
                    radius_min_pixels = 4,
                    get_position = geometry)

full_map
```
```

