---
title: "Northern Fur Seal Movement, Dive Behavior, and Oceanography in the Bering Sea and Pacific Ocean"
execute:
  echo: false
  warning: false
  message: false
format: html
search: false

author:
  - id: jml
    name:
      literal: Josh M. London
    email: josh.london@noaa.gov
    orcid: string
    attributes:
      corresponding: true
    affiliations: 
      - ref: mml
  - id: skh
    name:
      literal: Stacie K. Hardy
    email: stacie.hardy@noaa.gov
    affiliations: 
      - ref: mml
  - id: ajo
    name:
      literal: Anthony J. Orr
    email: tony.orr@noaa.gov
    affiliations: 
      - ref: mml
  - id: cek
    name:
      literal: Carey E. Kuhn
    email: carey.kuhn@noaa.gov
    affiliations: 
      - ref: mml
affiliations:
  - id: mml
    name: AFSC Marine Mammal Laboratory, NOAA Fisheries
    address: 7600 Sand Point Way NE
    city: Seattle
    region: Washington
    country: United States
    postal-code: 98115
    url: https://www.fisheries.noaa.gov/about/marine-mammal-laboratory
---

```{r}
#| include: false
library(dplyr)
library(purrr)
library(fs)
library(tidyr)
library(lubridate)
library(stringr)
library(ggplot2)
library(janitor)
library(readr)
library(googlesheets4)
library(wcUtils)
library(scam)
library(sf)
library(trip)
library(crawl)
library(crawlUtils)
library(googlesheets4)
library(rdeck)

r_files <- fs::dir_ls(here::here('R'), glob = "*.R")
map(r_files, source)
deploy_tbl <- read_rds(here::here('data/deploy_tbl.rds'))
```

```{r}
#| include: false
data_list <- get_wc_data()
```

:::{.callout-warning}
The information on this page is automatically updated every hour and without
any significant quality checks. Errors may be present and are likely. We are
providing access to the information in a public forum in the spirit of open
science and to provide easy access to updated information for the authors and
interested researchers. 

**The information provided here should not be cited or
referenced in any form**
:::

::: {.column-margin}
Disclaimer

The scientific results and conclusions, as well as any views or opinions
expressed herein, are those of the author(s) and do not necessarily reflect the
views of NMFS, NOAA, or the Department of Commerce. 
:::

## Predicted Movements

![](https://images.phylopic.org/images/7ce9ff63-7eec-4fc3-8f37-5f66f9b924a9/thumbnail/192x192.png){style="float: left; padding: 0 10px 0 0;"}
In September 2022 bio-loggers
([SPLASH-F](https://wildlifecomputers.com/our-tags/splash-archiving-tags/splash-f/),
Wildlife Computers[^1], Redmond, Washington) were deployed on adult female northern
fur seals at San Miguel Island, California (n=6) and St. Paul Island, Alaska
(n=6) in September of 2022. The two maps below provide near real-time predicted
movement paths based on a continuous time correlated random walk model. This
movement model uses Argos and Fastloc GPS derived locations to produce a
predicted path that most-likely represents that actual movement of the seal.
Here, the path shown is based on hourly predictions. New data
are downloaded, processed, and modeled at least hourly every day.

[^1]: Any reference to specific commercial products, processes, or services by
  service mark, trademark, manufacturer, or otherwise, does not constitute or
  imply their endorsement, recommendation or favoring by the Department of
  Commerce.

The maps below are interactive and can be zoomed in/out using the scroll wheel
on the mouse. Additionally, the solid dots indicate the last known location.
Hovering over a dot will show the deployid and date time associated with that
location.

```{r}
#| include: false

locs <- sf::st_as_sf(data_list$locs,
                     coords = c("longitude","latitude"),
                     crs = 4326) %>% 
  left_join(deploy_tbl) %>% 
  dplyr::filter(date_time > deploy_date_time_gmt) %>% 
  dplyr::rename(datetime=date_time)

locs <- locs %>%
  group_by(deployid) %>%
  arrange(datetime, error_radius) %>%
    mutate(
      rank = 1L,
      rank = case_when(duplicated(datetime, fromLast = FALSE) ~
                         lag(rank) + 1L, TRUE ~ rank)) %>%
    dplyr::filter(rank == 1) %>% 
  arrange(datetime) %>% 
  filter_tracks() %>% 
  sf::st_transform(32606) %>% 
  cu_add_argos_cols()

locs_fit <- locs %>% 
  group_by(deployid) %>% 
  group_map(~cu_crw_argos(.x), .keep = TRUE) %>% 
  purrr::flatten()

predict_pts <- locs_fit %>% 
  cu_crw_predict(predTime="1 hour", as_sf=FALSE)

deploy_ids <- predict_pts %>% map("deployid") %>% map_chr(head,1L)

predict_pts_sf <- predict_pts %>%  
  map(crw_as_sf,locType = "p", ftype = "POINT") %>%
  bind_rows() %>% 
  left_join(deploy_tbl)

predict_lines_sf <- predict_pts %>% 
  map(crw_as_sf,locType = "p", ftype = "LINESTRING") %>%
  set_names(deploy_ids) %>% 
  bind_rows(.id="deployid") %>% 
  select(-id) %>% 
  left_join(deploy_tbl)
                                 

lines_smi <- filter(predict_lines_sf, deployment_location == "San Miguel Island, CA") %>% 
  sf::st_transform(4326)
lines_stp <- filter(predict_lines_sf, deployment_location == "St. Paul Island, AK") %>% 
  sf::st_transform(4326)

smi_init <- st_bbox(lines_smi) %>% 
  st_as_sfc() %>% 
st_buffer(100000)

stp_init <- st_bbox(lines_stp) %>% 
  st_as_sfc() %>% 
st_buffer(100000)

locs_smi <- filter(predict_pts_sf, deployment_location == "San Miguel Island, CA") %>% 
  sf::st_transform(4326) %>% 
  group_by(deployid) %>% 
  arrange(deployid,datetime) %>% 
  group_map(~ tail(.x, 1L), .keep=TRUE) %>% 
  bind_rows()

locs_stp <- filter(predict_pts_sf, deployment_location == "St. Paul Island, AK") %>% 
  sf::st_transform(4326) %>% 
  group_by(deployid) %>% 
  arrange(deployid,datetime) %>% 
  group_map(~ tail(.x, 1L), .keep=TRUE) %>% 
  bind_rows()

smi_map <- rdeck(map_style = "mapbox://styles/jmlondon/cl9kktfl2000v16pooqw5p2wz",
                initial_bounds = smi_init,
                controller = TRUE) %>%
  add_path_layer(data = lines_smi,
                    name = "San Miguel",
                    opacity = 0.8,
                    get_color = scale_color_category(
                      col = deployid,
                      palette = scales::brewer_pal("seq","Oranges")
                      ),
                    wrap_longitude = TRUE,
                    position_format = "XY",
                    width_min_pixels = 1.5,
                    get_path = geometry) %>%
  add_scatterplot_layer(data = locs_smi,
                    name = "San Miguel",
                    opacity = 1,
                    get_fill_color = scale_color_category(
                      col = deployid,
                      palette = scales::brewer_pal("seq","Oranges"),
                      legend = FALSE
                      ),
                    wrap_longitude = TRUE,
                    position_format = "XY",
                    radius_min_pixels = 4,
                    get_position = geometry,
                    pickable = TRUE,
                    tooltip = c(deployid,datetime))

stp_map <- rdeck(map_style = "mapbox://styles/jmlondon/cl9kktfl2000v16pooqw5p2wz",
                initial_bounds = stp_init,
                controller = TRUE) %>%
  add_path_layer(data = lines_stp,
                    name = "St. Paul",
                    opacity = 0.8,
                    get_color = scale_color_category(
                      col = deployid,
                      palette = scales::brewer_pal("seq","Reds")
                      ),
                    wrap_longitude = TRUE,
                    position_format = "XY",
                    width_min_pixels = 1.5,
                    get_path = geometry) %>% 
  
  add_scatterplot_layer(data = locs_stp,
                    name = "St. Paul",
                    opacity = 1,
                    get_fill_color = scale_color_category(
                      col = deployid,
                      palette = scales::brewer_pal("seq","Reds"),
                      legend = FALSE
                      ),
                    wrap_longitude = TRUE,
                    position_format = "XY",
                    radius_min_pixels = 4,
                    get_position = geometry,
                    pickable = TRUE,
                    tooltip = c(deployid,datetime))
```

::: {.column-page}

```{r}
#| layout: [[1,1]]
smi_map
stp_map
```

:::

## Dive Behavior

![](https://images.phylopic.org/images/7ce9ff63-7eec-4fc3-8f37-5f66f9b924a9/thumbnail/192x192.png){style="float: left; padding: 0 10px 0 0;"}
The SPLASH-F bio-loggers were programmed with a new option for summarizing
dive behavior. The Argos satellite network has limited bandwidth available for
transmitting data. This, combined with the inherent nature of a marine mammal
to spend considerable time at sea and under water, restricts the amount of
information that can be transmitted. The Empirical Cumulative Distribution (ECD) of
time at depth provides an efficient and flexible data message for summarizing
the proportion of time spent at varying depths during specified time periods.
Unlike previous dive summary messages (e.g. histograms), the depth bins are not
specified in advance. The ECD adjusts to always include the full range of depths
explored during the summary period.

In this study, the ECD summary period was specified at 1 hour. This is the
finest resolution summary period and aligns well with our movement model
prediction interval. However, such resolution comes at a cost. The transmission
buffer on the SPLASH-F is limited to 100 messages and only 2 summary periods are
encoded in a single message (in this study: 2 hours per message). In addition to
ECD messages, the SPLASH-F is also collecting Fastloc GPS data and oceanographic
depth and temperature profiles. Since approximately 25 messages are generated
per day that means the buffer holds about 4 days worth of messages. Fur seals,
spend relatively little time at the surface when at sea and, thus, not all
messages are successfully transmitted. This is apparent in the plots below
where there are open gaps in the timeline representing hours for which no data
is available.

A key objective of this study is to push the limits of transmission so we can
learn from real-world deployments in challenging environments. With this 
information we can work with Wildlife Computers to improve the capabilities and
make better informed programming decisions in the future.


```{r}

ecd_data <- data_list$ecdf %>% 
  dplyr::rename(deployid = deploy_id) %>% 
  dplyr::arrange(deployid, start) %>% 
  rowwise() %>% 
  dplyr::mutate(smoothed = list(smooth_ecdf(full_ecdf, bin.width=5))) %>% 
  dplyr::select(c(deployid,start:percent_dry,shallow_ecdf, deep_ecdf,full_ecdf,smoothed)) %>% 
  unnest(smoothed, keep_empty = TRUE) %>% 
  group_by(deployid, start, end, kind, percent_dry) %>% 
  dplyr::arrange(deployid, start, depth_break) %>% 
  dplyr::mutate(propTAD = c(0,diff(ecd_prop)),
                minTAD = 60*(1-0.01*percent_dry) * propTAD) %>% 
  # determine the next depth value
  dplyr::mutate(next_depth = dplyr::lead(depth_break)) %>%
  # determine previous depth for plotting
  dplyr::mutate(prev_depth = dplyr::lag(depth_break)) %>%
  dplyr::select(-next_depth) %>%
  # transform depths to negative values
  dplyr::mutate(depth_break = depth_break * -1,
                prev_depth = prev_depth * -1)

ecd_data <- ecd_data %>% 
  group_by(deployid) %>% 
  arrange(start)
```

::: {.column-page}

```{r}
#| layout: [[1,1]]
#| fig-asp: 1.85
#| fig-width: 5.75

ecd_data %>% 
  left_join(deploy_tbl) %>% 
  filter(deployment_location == "San Miguel Island, CA") %>% 
ggplot() +
  geom_rect(aes(xmin = start, xmax = end,
                ymin = 0, ymax = percent_dry/10),
            fill = "seashell3") +
  geom_rect(aes(xmin = start, xmax = end,
                ymin = depth_break, ymax = prev_depth,
                fill = propTAD),
            color = NA) +
  scale_fill_distiller(palette = "Oranges",
                   direction = 1, trans = "log10",
                       guide = guide_colorbar(
                         title = 'proportion of time submerged',
                         title.position = 'bottom',
                         title.hjust = 0.5,
                         barwidth = unit(75, units = "mm"),
                         barheight = unit(2, units = "mm"))) +
  facet_grid(deployid ~ .) +
  theme_minimal() +
  ylab("depth (meters)") +
  labs(title = "San Miguel Island, CA",
       subtitle = "each bar represents 1 hour binned at 5m depth increments",
       caption = stringr::str_wrap("data derived from the Emperical Cummulative Distribution (ECD) of time at depth transmitted via the Argos satellite network")) +
  theme_minimal() +
  theme(legend.position = "bottom")

ecd_data %>% 
  left_join(deploy_tbl) %>% 
  filter(deployment_location == "St. Paul Island, AK") %>% 
ggplot() +
  geom_rect(aes(xmin = start, xmax = end,
                ymin = 0, ymax = percent_dry/10),
            fill = "seashell3") +
  geom_rect(aes(xmin = start, xmax = end,
                ymin = depth_break, ymax = prev_depth,
                fill = propTAD),
            color = NA) +
  scale_fill_distiller(palette = "Reds",
                   direction = 1, trans = "log10",
                       guide = guide_colorbar(
                         title = 'proportion of time submerged',
                         title.position = 'bottom',
                         title.hjust = 0.5,
                         barwidth = unit(75, units = "mm"),
                         barheight = unit(2, units = "mm"))) +
  facet_grid(deployid ~ .) +
  theme_minimal() +
  ylab("depth (meters)") +
  labs(title = "St Paul Island, AK",
       subtitle = " ",
       caption = stringr::str_wrap("data derived from the Emperical Cummulative Distribution (ECD) of time at depth transmitted via the Argos satellite network")) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

:::

## Oceanographic Temperature Profiles

Plots of ocean temperature profiles coming soon!
